// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// JUEGOS Y CONFIGURACI√ìN
// ============================================

model Game {
  id            String        @id @default(uuid())
  name          String        // "LOTOANIMALITO", "TRIPLE PANTERA"
  type          GameType      // "ANIMALITOS" | "TRIPLE" | "ROULETTE"
  slug          String        @unique
  totalNumbers  Int           // 38 para animalitos, 1000 para triple
  isActive      Boolean       @default(true)
  description   String?
  config        Json?         // Configuraci√≥n adicional del juego
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relaciones
  items         GameItem[]
  templates     DrawTemplate[]
  draws         Draw[]
  pauses        DrawPause[]
  apiConfigs    ApiConfiguration[]
  channels      GameChannel[]
  users         UserGame[]    // Usuarios asociados al juego
  adminBots     AdminBotGame[] // Bots de admin asignados
  
  @@index([slug])
  @@index([isActive])
}

enum GameType {
  ANIMALITOS
  TRIPLE
  ROULETTE
}

// ============================================
// ITEMS DEL JUEGO (N√∫meros/Animales)
// ============================================

model GameItem {
  id            String    @id @default(uuid())
  gameId        String
  number        String    // "00", "01", "000", "999"
  name          String    // "BALLENA", "CARNERO", etc.
  displayOrder  Int       // Para ordenar
  multiplier    Decimal   @default(30.00) @db.Decimal(10, 2)
  lastWin       DateTime? // √öltima vez que gan√≥
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relaciones
  game                Game              @relation(fields: [gameId], references: [id], onDelete: Cascade)
  drawsAsPreselected  Draw[]            @relation("PreselectedItem")
  drawsAsWinner       Draw[]            @relation("WinnerItem")
  ticketDetails       TicketDetail[]
  
  @@unique([gameId, number])
  @@index([gameId])
  @@index([gameId, isActive])
}

// ============================================
// PLANTILLAS DE SORTEOS
// ============================================

model DrawTemplate {
  id          String    @id @default(uuid())
  gameId      String
  name        String    // "Plantilla Lunes-Viernes", "Plantilla Fin de Semana"
  description String?
  daysOfWeek  Int[]     // [1,2,3,4,5] (1=Lunes, 7=Domingo)
  drawTimes   String[]  // ["08:00", "09:00", "10:00"]
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relaciones
  game        Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  draws       Draw[]
  
  @@index([gameId])
  @@index([isActive])
}

// ============================================
// SORTEOS
// ============================================

model Draw {
  id                  String        @id @default(uuid())
  gameId              String
  templateId          String?
  drawDate            DateTime      @db.Date // Fecha del sorteo (solo fecha, sin hora)
  drawTime            String        // Hora del sorteo en formato "HH:MM:SS"
  scheduledAt         DateTime?     // DEPRECATED: Mantener por compatibilidad temporal, ser√° eliminado
  status              DrawStatus    @default(SCHEDULED)
  preselectedItemId   String?       // N√∫mero preseleccionado (opcional)
  winnerItemId        String?       // N√∫mero ganador
  imageUrl            String?       // URL de la imagen generada
  imageGenerated      Boolean       @default(false) // Si la imagen fue generada
  imageGeneratedAt    DateTime?     // Cuando se gener√≥ la imagen
  imageError          String?       // Error en generaci√≥n de imagen
  videoUrl            String?       // URL del video generado
  videoGeneratedAt    DateTime?     // Cuando se gener√≥ el video
  videoError          String?       // Error en generaci√≥n de video
  closedAt            DateTime?     // Cuando se cerr√≥ (5 min antes)
  drawnAt             DateTime?     // Cuando se ejecut√≥
  publishedAt         DateTime?     // Cuando se public√≥
  notes               String?       // Notas adicionales
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  // Relaciones
  game                Game              @relation(fields: [gameId], references: [id], onDelete: Cascade)
  template            DrawTemplate?     @relation(fields: [templateId], references: [id], onDelete: SetNull)
  preselectedItem     GameItem?         @relation("PreselectedItem", fields: [preselectedItemId], references: [id], onDelete: SetNull)
  winnerItem          GameItem?         @relation("WinnerItem", fields: [winnerItemId], references: [id], onDelete: SetNull)
  publications        DrawPublication[]
  apiMappings         ApiDrawMapping[]
  tickets             Ticket[]
  stats               DrawStats?        // Estad√≠sticas del sorteo
  providerStats       ProviderStats[]   // Estad√≠sticas por proveedor
  
  @@index([gameId])
  @@index([drawDate])
  @@index([status])
  @@index([gameId, drawDate])
  @@index([gameId, drawDate, drawTime])
  @@index([gameId, status])
}

enum DrawStatus {
  SCHEDULED   // Programado
  CLOSED      // Cerrado (5 min antes)
  DRAWN       // Ejecutado (n√∫mero seleccionado)
  PUBLISHED   // Publicado en canales
  CANCELLED   // Cancelado
}

// ============================================
// PUBLICACIONES EN CANALES
// ============================================

model DrawPublication {
  id          String            @id @default(uuid())
  drawId      String
  channel     Channel
  status      PublicationStatus @default(PENDING)
  sentAt      DateTime?
  externalId  String?           // ID del mensaje en el canal (Telegram, etc)
  error       String?
  retries     Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  // Relaciones
  draw        Draw              @relation(fields: [drawId], references: [id], onDelete: Cascade)
  
  @@unique([drawId, channel])
  @@index([drawId])
  @@index([status])
  @@index([channel, status])
}

enum Channel {
  TELEGRAM
  WHATSAPP
  FACEBOOK
  INSTAGRAM
  TIKTOK
}

enum PublicationStatus {
  PENDING   // Pendiente
  SENT      // Enviado
  FAILED    // Fallido
  SKIPPED   // Omitido
}

// ============================================
// PAUSAS DE SORTEOS
// ============================================

model DrawPause {
  id          String    @id @default(uuid())
  gameId      String
  startDate   DateTime  // Fecha de inicio
  endDate     DateTime  // Fecha de fin
  reason      String?   // Raz√≥n de la pausa
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relaciones
  game        Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  @@index([gameId])
  @@index([startDate, endDate])
  @@index([gameId, isActive])
}

// ============================================
// CONFIGURACI√ìN DEL SISTEMA
// ============================================

model SystemConfig {
  id          String    @id @default(uuid())
  key         String    @unique // Clave de configuraci√≥n (ej: "emergency_stop")
  value       String    // Valor (JSON string)
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([key])
}

model BetSimulatorConfig {
  id              String    @id @default(uuid())
  enabled         Boolean   @default(false)
  lastExecutedAt  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ============================================
// CONFIGURACI√ìN DE CANALES
// ============================================

model ChannelConfig {
  id          String    @id @default(uuid())
  name        String    // "Canal Telegram Principal"
  type        Channel
  config      Json      // Credenciales y configuraci√≥n (encriptada)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([type, name])
  @@index([type, isActive])
}

// ============================================
// CANALES POR JUEGO
// ============================================

model GameChannel {
  id                    String    @id @default(uuid())
  gameId                String
  channelType           Channel   // TELEGRAM, WHATSAPP, etc.
  name                  String    // "WhatsApp Principal", "Telegram VIP"
  
  // Referencias a instancias de cada plataforma
  whatsappInstanceId    String?   // ID de la instancia de WhatsApp
  telegramInstanceId    String?   // ID de la instancia de Telegram
  instagramInstanceId   String?   // ID de la instancia de Instagram
  facebookInstanceId    String?   // ID de la instancia de Facebook
  tiktokInstanceId      String?   // ID de la instancia de TikTok
  
  // Configuraci√≥n espec√≠fica del canal (para compatibilidad)
  telegramChatId        String?   // ID del chat/canal de Telegram (para TELEGRAM)
  
  // Plantilla de mensaje (Mustache syntax)
  messageTemplate       String    @default("üé∞ *{{gameName}}*\n\n‚è∞ Hora: {{time}}\nüéØ Resultado: *{{winnerNumber}}*\nüèÜ {{winnerName}}\n\n‚ú® ¬°Buena suerte en el pr√≥ximo sorteo!")
  
  // Destinatarios (para canales que requieren lista de n√∫meros/usuarios)
  recipients            String[]  @default([]) // Array de n√∫meros de tel√©fono o IDs de usuario
  
  isActive              Boolean   @default(true)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relaciones
  game                  Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  @@unique([gameId, channelType, name])
  @@index([gameId])
  @@index([channelType])
  @@index([isActive])
  @@index([whatsappInstanceId])
  @@index([telegramInstanceId])
  @@index([instagramInstanceId])
  @@index([facebookInstanceId])
  @@index([tiktokInstanceId])
}

// ============================================
// USUARIOS Y AUTENTICACI√ìN
// ============================================

model User {
  id              String    @id @default(uuid())
  username        String    @unique
  email           String    @unique
  password        String    // Hash bcrypt
  role            UserRole  @default(OPERATOR)
  telegramUserId  String?   @unique // Para bot de Telegram
  telegramChatId  String?   // Chat ID para notificaciones directas
  isActive        Boolean   @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Campos para jugadores (PLAYER role)
  phone           String?   @unique
  phoneVerified   Boolean   @default(false)
  balance         Decimal   @default(0) @db.Decimal(12, 2)
  blockedBalance  Decimal   @default(0) @db.Decimal(12, 2)
  
  // Relaciones
  auditLogs       AuditLog[]
  games           UserGame[]  // Juegos asociados al usuario
  telegramLinkCode TelegramLinkCode? // C√≥digo de vinculaci√≥n temporal
  tickets         Ticket[]
  deposits        Deposit[]
  withdrawals     Withdrawal[]
  pagoMovilAccounts PagoMovilAccount[]
  pageVisits      PageVisit[]
  tripleBets      TripleBet[]
  movements       PlayerMovement[]  // Historial de movimientos (trazabilidad)
  playerStats     PlayerStats?      // Estad√≠sticas acumuladas
  
  @@index([username])
  @@index([email])
  @@index([isActive])
  @@index([phone])
}

// Relaci√≥n muchos a muchos entre usuarios y juegos
model UserGame {
  id        String   @id @default(uuid())
  userId    String
  gameId    String
  notify    Boolean  @default(true) // Si debe recibir notificaciones
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  @@unique([userId, gameId])
  @@index([userId])
  @@index([gameId])
}

enum UserRole {
  ADMIN           // Acceso completo
  OPERATOR        // Gesti√≥n de sorteos
  VIEWER          // Solo lectura
  PLAYER          // Usuario jugador (taquilla online)
  TAQUILLA_ADMIN  // Administrador de taquilla online
}

// ============================================
// AUDITOR√çA
// ============================================

model AuditLog {
  id          String    @id @default(uuid())
  userId      String?
  action      String    // "DRAW_CREATED", "WINNER_CHANGED", etc.
  entity      String    // "Draw", "Game", etc.
  entityId    String
  changes     Json?     // Cambios realizados
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())
  
  // Relaciones
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@index([action])
}

// ============================================
// INTEGRACI√ìN CON APIs EXTERNAS
// ============================================

model ApiSystem {
  id            String            @id @default(uuid())
  name          String            // "SRQ", "OtroSistema"
  description   String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  // Relaciones
  configurations ApiConfiguration[]
  comerciales   ProviderComercial[]
  
  @@index([name])
}

model ApiConfiguration {
  id            String            @id @default(uuid())
  name          String            // "SRQ Planificaci√≥n Juego X"
  apiSystemId   String
  gameId        String
  type          ApiConfigType     // "PLANNING" | "SALES"
  baseUrl       String            // URL base del endpoint
  token         String            // Token de autenticaci√≥n
  tripletaUrl   String?           // URL para tripleta (opcional, espec√≠fico por juego)
  tripletaToken String?           // Token para tripleta (opcional, espec√≠fico por juego)
  isActive      Boolean           @default(true)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  // Relaciones
  apiSystem     ApiSystem         @relation(fields: [apiSystemId], references: [id], onDelete: Cascade)
  game          Game              @relation(fields: [gameId], references: [id], onDelete: Cascade)
  drawMappings  ApiDrawMapping[]
  
  @@index([apiSystemId])
  @@index([gameId])
  @@index([type])
  @@index([isActive])
}

enum ApiConfigType {
  PLANNING  // Para obtener planificaci√≥n de sorteos
  SALES     // Para obtener ventas/tickets
}

model ApiDrawMapping {
  id              String            @id @default(uuid())
  apiConfigId     String
  drawId          String
  externalDrawId  String            // ID del sorteo en el sistema externo
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relaciones
  apiConfig       ApiConfiguration  @relation(fields: [apiConfigId], references: [id], onDelete: Cascade)
  draw            Draw              @relation(fields: [drawId], references: [id], onDelete: Cascade)
  
  @@unique([externalDrawId])
  @@unique([drawId, apiConfigId])
  @@index([apiConfigId])
  @@index([drawId])
}

// ============================================
// ENTIDADES DE PROVEEDORES
// Jerarqu√≠a: Comercial ‚Üí Banca ‚Üí Grupo ‚Üí Taquilla
// ============================================

model ProviderComercial {
  id            String          @id @default(uuid())
  externalId    Int             // ID del proveedor externo
  apiSystemId   String          // ID del ApiSystem (proveedor)
  name          String?         // Nombre (se llenar√° despu√©s)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  apiSystem     ApiSystem       @relation(fields: [apiSystemId], references: [id], onDelete: Cascade)
  bancas        ProviderBanca[]
  
  @@unique([apiSystemId, externalId])
  @@index([apiSystemId])
  @@index([externalId])
}

model ProviderBanca {
  id            String              @id @default(uuid())
  externalId    Int                 // ID del proveedor externo
  comercialId   String
  name          String?
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  comercial     ProviderComercial   @relation(fields: [comercialId], references: [id], onDelete: Cascade)
  grupos        ProviderGrupo[]
  
  @@unique([comercialId, externalId])
  @@index([comercialId])
  @@index([externalId])
}

model ProviderGrupo {
  id            String          @id @default(uuid())
  externalId    Int
  bancaId       String
  name          String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  banca         ProviderBanca   @relation(fields: [bancaId], references: [id], onDelete: Cascade)
  taquillas     ProviderTaquilla[]
  
  @@unique([bancaId, externalId])
  @@index([bancaId])
  @@index([externalId])
}

model ProviderTaquilla {
  id            String          @id @default(uuid())
  externalId    Int
  grupoId       String
  name          String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  grupo         ProviderGrupo   @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  
  @@unique([grupoId, externalId])
  @@index([grupoId])
  @@index([externalId])
}

// ============================================
// INSTANCIAS DE CANALES MULTI-PLATAFORMA
// ============================================

// Instancias de WhatsApp (mantener compatibilidad)
model WhatsAppInstance {
  id              String            @id @default(uuid())
  instanceId      String            @unique // ID √∫nico de la instancia (ej: "instance-1")
  name            String            // Nombre descriptivo
  phoneNumber     String?           // N√∫mero de tel√©fono conectado
  status          WhatsAppStatus    @default(DISCONNECTED)
  qrCode          String?           // √öltimo QR generado
  qrGeneratedAt   DateTime?         // Cuando se gener√≥ el QR
  connectedAt     DateTime?         // Cuando se conect√≥ por √∫ltima vez
  lastSeen        DateTime          @default(now()) // √öltima actividad
  sessionData     Json?             // Datos adicionales de la sesi√≥n
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([instanceId])
  @@index([status])
  @@index([isActive])
}

enum WhatsAppStatus {
  CONNECTING      // Iniciando conexi√≥n
  QR_READY        // QR generado, esperando escaneo
  CONNECTED       // Conectado y activo
  DISCONNECTED    // Desconectado
  LOGGED_OUT      // Sesi√≥n cerrada por el usuario
}

// Instancias de Telegram
model TelegramInstance {
  id              String            @id @default(uuid())
  instanceId      String            @unique // ID √∫nico de la instancia
  name            String            // Nombre descriptivo
  botToken        String            // Token del bot de Telegram
  chatId          String?           // ID del chat/canal por defecto
  webhookUrl      String?           // URL del webhook (opcional)
  status          PlatformStatus    @default(DISCONNECTED)
  connectedAt     DateTime?         // Cuando se conect√≥ por √∫ltima vez
  lastSeen        DateTime          @default(now()) // √öltima actividad
  config          Json?             // Configuraci√≥n adicional
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([instanceId])
  @@index([status])
  @@index([isActive])
}

// Instancias de Instagram
model InstagramInstance {
  id              String            @id @default(uuid())
  instanceId      String            @unique // ID √∫nico de la instancia
  name            String            // Nombre descriptivo
  appId           String            // Facebook App ID
  appSecret       String            // Facebook App Secret (encriptado)
  accessToken     String?           // Access token de Instagram
  refreshToken    String?           // Refresh token
  tokenExpiresAt  DateTime?         // Expiraci√≥n del token
  userId          String?           // Instagram User ID
  username        String?           // Instagram username
  status          PlatformStatus    @default(DISCONNECTED)
  connectedAt     DateTime?         // Cuando se conect√≥ por √∫ltima vez
  lastSeen        DateTime          @default(now()) // √öltima actividad
  config          Json?             // Configuraci√≥n adicional
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([instanceId])
  @@index([status])
  @@index([isActive])
}

// Instancias de Facebook
model FacebookInstance {
  id              String            @id @default(uuid())
  instanceId      String            @unique // ID √∫nico de la instancia
  name            String            // Nombre descriptivo
  pageAccessToken String            // Page Access Token (encriptado)
  appSecret       String            // App Secret (encriptado)
  webhookToken    String            // Webhook verify token
  pageId          String            // Facebook Page ID
  pageName        String?           // Nombre de la p√°gina
  status          PlatformStatus    @default(DISCONNECTED)
  connectedAt     DateTime?         // Cuando se conect√≥ por √∫ltima vez
  lastSeen        DateTime          @default(now()) // √öltima actividad
  config          Json?             // Configuraci√≥n adicional
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([instanceId])
  @@index([status])
  @@index([isActive])
}

// Instancias de TikTok
model TikTokInstance {
  id              String            @id @default(uuid())
  instanceId      String            @unique // ID √∫nico de la instancia
  name            String            // Nombre descriptivo
  clientKey       String            // TikTok Client Key
  clientSecret    String            // TikTok Client Secret (encriptado)
  accessToken     String?           // Access token
  refreshToken    String?           // Refresh token
  tokenExpiresAt  DateTime?         // Expiraci√≥n del access token
  refreshExpiresAt DateTime?        // Expiraci√≥n del refresh token
  openId          String?           // TikTok Open ID del usuario
  scope           String?           // Permisos autorizados
  status          PlatformStatus    @default(DISCONNECTED)
  connectedAt     DateTime?         // Cuando se conect√≥ por √∫ltima vez
  lastSeen        DateTime          @default(now()) // √öltima actividad
  config          Json?             // Configuraci√≥n adicional
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([instanceId])
  @@index([status])
  @@index([isActive])
}

// Estado com√∫n para todas las plataformas (excepto WhatsApp que mantiene su enum)
enum PlatformStatus {
  CONNECTING      // Iniciando conexi√≥n
  CONNECTED       // Conectado y activo
  DISCONNECTED    // Desconectado
  ERROR           // Error de conexi√≥n
  EXPIRED         // Token expirado
}

// ============================================
// BOTS DE ADMINISTRACI√ìN (Notificaciones)
// ============================================

// Bot de Telegram para notificaciones a administradores
model AdminTelegramBot {
  id              String            @id @default(uuid())
  name            String            // Nombre descriptivo del bot
  botToken        String            @unique // Token del bot de Telegram
  botUsername     String?           // Username del bot (@bot_name)
  status          PlatformStatus    @default(DISCONNECTED)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relaciones
  gameAssignments AdminBotGame[]    // Juegos asignados a este bot
  
  @@index([status])
  @@index([isActive])
}

// Relaci√≥n entre bots de admin y juegos
model AdminBotGame {
  id        String           @id @default(uuid())
  botId     String
  gameId    String
  createdAt DateTime         @default(now())
  
  bot       AdminTelegramBot @relation(fields: [botId], references: [id], onDelete: Cascade)
  game      Game             @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  @@unique([botId, gameId])
  @@index([botId])
  @@index([gameId])
}

// C√≥digo de vinculaci√≥n temporal para usuarios
model TelegramLinkCode {
  id        String   @id @default(uuid())
  userId    String   @unique
  code      String   @unique // C√≥digo de 6 d√≠gitos
  expiresAt DateTime // Expira en 10 minutos
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([code])
  @@index([expiresAt])
}

// ============================================
// SISTEMA DE TAQUILLA ONLINE - FASE 1
// ============================================

// Cuentas Pago M√≥vil del Sistema (para recibir pagos)
model SystemPagoMovil {
  id          String    @id @default(uuid())
  bankCode    String    // C√≥digo del banco (0102, 0134, etc.)
  bankName    String    // Nombre del banco
  phone       String    // N√∫mero de tel√©fono
  cedula      String    // C√©dula del titular
  holderName  String    // Nombre del titular
  isActive    Boolean   @default(true)
  priority    Int       @default(0) // Para ordenar cu√°l mostrar primero
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  deposits    Deposit[]
  
  @@index([isActive])
  @@index([priority])
}

// Cuentas Pago M√≥vil del Usuario (para recibir retiros)
model PagoMovilAccount {
  id          String    @id @default(uuid())
  userId      String
  bankCode    String
  bankName    String
  phone       String
  cedula      String
  holderName  String
  isDefault   Boolean   @default(false)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  withdrawals Withdrawal[]
  
  @@index([userId])
  @@index([userId, isDefault])
}

enum DepositStatus {
  PENDING     // Esperando validaci√≥n
  APPROVED    // Aprobado, saldo acreditado
  REJECTED    // Rechazado
}

model Deposit {
  id                  String        @id @default(uuid())
  userId              String
  systemPagoMovilId   String
  amount              Decimal       @db.Decimal(12, 2)
  reference           String        // Referencia del pago m√≥vil
  phone               String        // Tel√©fono desde donde se hizo el pago
  bankCode            String        // Banco origen
  status              DepositStatus @default(PENDING)
  notes               String?       // Notas del admin
  processedBy         String?       // ID del admin que proces√≥
  processedAt         DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  systemPagoMovil     SystemPagoMovil @relation(fields: [systemPagoMovilId], references: [id])
  
  @@index([userId])
  @@index([status])
  @@index([reference])
  @@index([createdAt])
}

enum WithdrawalStatus {
  PENDING     // Solicitado, saldo bloqueado
  PROCESSING  // En proceso de pago
  COMPLETED   // Pagado
  REJECTED    // Rechazado, saldo desbloqueado
  CANCELLED   // Cancelado por usuario
}

model Withdrawal {
  id                  String            @id @default(uuid())
  userId              String
  pagoMovilAccountId  String
  amount              Decimal           @db.Decimal(12, 2)
  status              WithdrawalStatus  @default(PENDING)
  reference           String?           // Referencia del pago realizado
  notes               String?
  processedBy         String?
  processedAt         DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  pagoMovilAccount    PagoMovilAccount  @relation(fields: [pagoMovilAccountId], references: [id])
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// SISTEMA DE TAQUILLA ONLINE - FASE 2
// ============================================

enum TicketStatus {
  ACTIVE      // Ticket activo, sorteo no ha ocurrido
  WON         // Ticket ganador
  LOST        // Ticket perdedor
  CANCELLED   // Cancelado (reembolsado)
}

enum TicketSource {
  TAQUILLA_ONLINE   // Jugado por usuario en la plataforma
  EXTERNAL_API      // Importado de proveedor externo (SRQ, etc)
}

model Ticket {
  id              String        @id @default(uuid())
  userId          String?       // Null para tickets externos
  drawId          String
  source          TicketSource  @default(TAQUILLA_ONLINE)
  externalTicketId String?      // ID del ticket en el sistema externo (para SRQ)
  totalAmount     Decimal       @db.Decimal(12, 2)
  totalPrize      Decimal       @default(0) @db.Decimal(12, 2)
  status          TicketStatus  @default(ACTIVE)
  providerData    Json?         // Datos del proveedor (comercial, banca, grupo, taquilla)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  user            User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  draw            Draw          @relation(fields: [drawId], references: [id], onDelete: Cascade)
  details         TicketDetail[]
  
  @@index([userId])
  @@index([drawId])
  @@index([status])
  @@index([source])
  @@index([externalTicketId])
  @@index([userId, status])
  @@index([drawId, source])
  @@index([createdAt])
}

enum TicketDetailStatus {
  ACTIVE
  WON
  LOST
}

model TicketDetail {
  id          String              @id @default(uuid())
  ticketId    String
  gameItemId  String
  drawId      String?             // Sorteo espec√≠fico de este detalle (para tickets multi-sorteo)
  amount      Decimal             @db.Decimal(12, 2)
  multiplier  Decimal             @db.Decimal(10, 2) // Multiplicador al momento de la jugada
  prize       Decimal             @default(0) @db.Decimal(12, 2)
  status      TicketDetailStatus  @default(ACTIVE)
  createdAt   DateTime            @default(now())
  
  ticket      Ticket              @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  gameItem    GameItem            @relation(fields: [gameItemId], references: [id])
  
  @@index([ticketId])
  @@index([gameItemId])
  @@index([drawId])
}

// ============================================
// SISTEMA DE TRIPLETAS
// ============================================

enum TripletaStatus {
  ACTIVE      // Activa, esperando resultados
  WON         // Ganadora
  LOST        // Perdedora
  EXPIRED     // Expirada sin ganar
}

model TripleBet {
  id              String          @id @default(uuid())
  userId          String
  gameId          String
  item1Id         String          // Primer n√∫mero seleccionado
  item2Id         String          // Segundo n√∫mero seleccionado
  item3Id         String          // Tercer n√∫mero seleccionado
  amount          Decimal         @db.Decimal(12, 2)
  multiplier      Decimal         @db.Decimal(10, 2) // Multiplicador configurado al momento de la apuesta
  drawsCount      Int             // Cantidad de sorteos que aplica
  startDrawId     String          // Sorteo inicial (siguiente al momento de la apuesta)
  endDrawId       String?         // Sorteo final (se calcula al crear)
  winnerDrawId    String?         // Sorteo en el que gan√≥ (si aplica)
  prize           Decimal         @default(0) @db.Decimal(12, 2)
  status          TripletaStatus  @default(ACTIVE)
  expiresAt       DateTime        // Fecha de expiraci√≥n (basada en el √∫ltimo sorteo)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([gameId])
  @@index([status])
  @@index([userId, status])
  @@index([expiresAt])
  @@index([startDrawId])
}

// ============================================
// MOVIMIENTOS DE JUGADOR (Trazabilidad tipo banco)
// ============================================

enum MovementType {
  DEPOSIT         // Recarga de saldo
  WITHDRAWAL      // Retiro de saldo
  BET             // Jugada (descuento de saldo)
  PRIZE           // Premio ganado
  REFUND          // Reembolso (cancelaci√≥n de ticket)
  ADJUSTMENT      // Ajuste manual por admin
  BONUS           // Bonificaci√≥n
}

model PlayerMovement {
  id              String        @id @default(uuid())
  userId          String
  type            MovementType
  amount          Decimal       @db.Decimal(12, 2)  // Positivo = entrada, Negativo = salida
  balanceBefore   Decimal       @db.Decimal(12, 2)  // Saldo antes del movimiento
  balanceAfter    Decimal       @db.Decimal(12, 2)  // Saldo despu√©s del movimiento
  description     String?                           // Descripci√≥n del movimiento
  referenceType   String?                           // Tipo de referencia: TICKET, DEPOSIT, WITHDRAWAL, TRIPLETA
  referenceId     String?                           // ID de la referencia
  metadata        Json?                             // Datos adicionales (sorteo, juego, etc)
  createdBy       String?                           // Admin que hizo el ajuste (si aplica)
  createdAt       DateTime      @default(now())
  
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([referenceType, referenceId])
}

// ============================================
// ESTAD√çSTICAS DE SORTEO
// ============================================

model DrawStats {
  id              String        @id @default(uuid())
  drawId          String        @unique
  
  // Ventas
  totalSales      Decimal       @default(0) @db.Decimal(12, 2)  // Total vendido
  ticketCount     Int           @default(0)                      // Cantidad de tickets
  detailCount     Int           @default(0)                      // Cantidad de jugadas
  
  // Premios
  totalPrize      Decimal       @default(0) @db.Decimal(12, 2)  // Total en premios
  winnerCount     Int           @default(0)                      // Cantidad de ganadores
  
  // Balance
  grossProfit     Decimal       @default(0) @db.Decimal(12, 2)  // Ganancia bruta (ventas - premios)
  profitMargin    Decimal       @default(0) @db.Decimal(5, 2)   // Margen de ganancia %
  
  // Tripletas
  tripletaSales   Decimal       @default(0) @db.Decimal(12, 2)  // Ventas de tripletas
  tripletaPrize   Decimal       @default(0) @db.Decimal(12, 2)  // Premios de tripletas
  tripletaCount   Int           @default(0)                      // Cantidad de tripletas activas
  
  // Timestamps
  calculatedAt    DateTime      @default(now())                  // √öltima vez que se calcul√≥
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  draw            Draw          @relation(fields: [drawId], references: [id], onDelete: Cascade)
  
  @@index([drawId])
  @@index([calculatedAt])
}

// ============================================
// ESTAD√çSTICAS DE PROVEEDORES (Taquilla, Grupo, Banca, Comercial)
// ============================================

enum ProviderStatsLevel {
  TAQUILLA
  GRUPO
  BANCA
  COMERCIAL
}

model ProviderStats {
  id              String              @id @default(uuid())
  level           ProviderStatsLevel  // Nivel de la entidad
  entityId        String              // ID de la entidad (taquilla, grupo, banca, comercial)
  externalId      Int                 // ID externo de la entidad
  drawId          String              // Sorteo al que pertenecen las estad√≠sticas
  
  // Ventas
  totalSales      Decimal             @default(0) @db.Decimal(12, 2)
  ticketCount     Int                 @default(0)
  detailCount     Int                 @default(0)
  
  // Premios
  totalPrize      Decimal             @default(0) @db.Decimal(12, 2)
  winnerCount     Int                 @default(0)
  
  // Balance
  grossProfit     Decimal             @default(0) @db.Decimal(12, 2)
  profitMargin    Decimal             @default(0) @db.Decimal(5, 2)
  
  // Timestamps
  calculatedAt    DateTime            @default(now())
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  draw            Draw                @relation(fields: [drawId], references: [id], onDelete: Cascade)
  
  @@unique([level, entityId, drawId])
  @@index([level, entityId])
  @@index([drawId])
  @@index([externalId])
  @@index([calculatedAt])
}

// ============================================
// ESTAD√çSTICAS ACUMULADAS DEL JUGADOR
// ============================================

model PlayerStats {
  id              String        @id @default(uuid())
  userId          String        @unique
  
  // Tickets
  totalTickets    Int           @default(0)
  wonTickets      Int           @default(0)
  lostTickets     Int           @default(0)
  
  // Tripletas
  totalTripletas  Int           @default(0)
  wonTripletas    Int           @default(0)
  lostTripletas   Int           @default(0)
  
  // Montos
  totalBet        Decimal       @default(0) @db.Decimal(12, 2)  // Total apostado
  totalPrize      Decimal       @default(0) @db.Decimal(12, 2)  // Total ganado
  totalDeposits   Decimal       @default(0) @db.Decimal(12, 2)  // Total depositado
  totalWithdrawals Decimal      @default(0) @db.Decimal(12, 2)  // Total retirado
  
  // Timestamps
  lastBetAt       DateTime?                                      // √öltima apuesta
  lastWinAt       DateTime?                                      // √öltima ganancia
  calculatedAt    DateTime      @default(now())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

// ============================================
// SISTEMA DE RASTREO DE VISITAS
// ============================================

enum PageType {
  LANDING         // P√°gina de inicio
  ADMIN_DASHBOARD // Dashboard principal de admin
  ADMIN_SORTEOS   // M√≥dulo de sorteos
  ADMIN_JUEGOS    // M√≥dulo de juegos
  ADMIN_USUARIOS  // M√≥dulo de usuarios
  ADMIN_JUGADORES // M√≥dulo de jugadores
  ADMIN_DEPOSITOS // M√≥dulo de dep√≥sitos
  ADMIN_RETIROS   // M√≥dulo de retiros
  ADMIN_TICKETS   // M√≥dulo de tickets
  ADMIN_REPORTES  // M√≥dulo de reportes
  ADMIN_TELEGRAM  // M√≥dulo de Telegram
  ADMIN_WHATSAPP  // M√≥dulo de WhatsApp
  ADMIN_FACEBOOK  // M√≥dulo de Facebook
  ADMIN_INSTAGRAM // M√≥dulo de Instagram
  ADMIN_TIKTOK    // M√≥dulo de TikTok
  ADMIN_BOTS      // M√≥dulo de bots admin
  ADMIN_PAUSAS    // M√≥dulo de pausas
  ADMIN_CONFIG    // M√≥dulo de configuraci√≥n
  ADMIN_PERFIL    // Perfil de usuario
  ADMIN_CUENTAS   // Cuentas del sistema
  ADMIN_PAGO_MOVIL // Pago m√≥vil
  PLAYER_DASHBOARD // Dashboard de jugador
  PLAYER_JUGAR    // P√°gina de jugar
  PLAYER_BALANCE  // Balance hist√≥rico
  PLAYER_CUENTAS  // Cuentas de pago m√≥vil
  PLAYER_DEPOSITOS // Dep√≥sitos del jugador
  PLAYER_RETIROS  // Retiros del jugador
}

model PageVisit {
  id          String    @id @default(uuid())
  userId      String?   // Opcional, puede ser an√≥nimo
  pageType    PageType
  pagePath    String    // Ruta completa de la p√°gina
  userAgent   String?   // User agent del navegador
  ipAddress   String?   // IP del visitante
  referrer    String?   // De d√≥nde viene
  sessionId   String?   // ID de sesi√≥n para agrupar visitas
  duration    Int?      // Duraci√≥n en segundos (si se registra)
  createdAt   DateTime  @default(now())
  
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([pageType])
  @@index([createdAt])
  @@index([sessionId])
  @@index([pageType, createdAt])
}
